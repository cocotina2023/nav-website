# 更新日志 (Changelog)

本文档记录 nav-website 项目的所有重要变更。

## [未发布] - 2024-10-23

### 🐛 修复的问题 (Bug Fixes)

#### 关键问题修复

1. **空的 package.json 文件**
   - **问题**: 后端 package.json 文件完全为空，导致无法安装依赖和运行项目
   - **影响**: 项目完全无法启动
   - **修复**: 创建完整的 package.json，包含所有必需的依赖项
   - 依赖项: express, cors, body-parser, sqlite3, bcryptjs, jsonwebtoken, multer

2. **无效的数据库文件**
   - **问题**: database/nav.db 包含纯文本 SQL 而不是二进制 SQLite 数据库
   - **影响**: 数据库连接失败，所有数据操作无法执行
   - **修复**: 
     - 创建 database/schema.sql 定义数据库结构
     - 创建 database/init.js 初始化脚本
     - 更新 db.js 自动检测和修复无效数据库文件
     - 自动创建默认管理员账户

3. **空的 .gitignore 文件**
   - **问题**: .gitignore 为空，可能导致敏感文件被追踪
   - **影响**: node_modules、.env、日志文件等可能被提交到版本控制
   - **修复**: 添加完整的 .gitignore 规则

4. **空的 Dockerfile**
   - **问题**: Dockerfile 完全为空
   - **影响**: 无法构建 Docker 镜像
   - **修复**: 创建多阶段构建 Dockerfile，优化镜像大小

5. **缺失的 style.css**
   - **问题**: 前端 main.js 导入 './style.css' 但文件不存在
   - **影响**: 前端启动失败或样式丢失
   - **修复**: 创建全局样式文件

6. **缺失的 @vitejs/plugin-vue**
   - **问题**: vite.config.mjs 导入该插件但未在 package.json 中声明
   - **影响**: 前端构建失败
   - **修复**: 添加到 devDependencies

7. **MenuBar 组件样式截断**
   - **问题**: MenuBar.vue 的 CSS 样式不完整
   - **影响**: 菜单栏显示异常
   - **修复**: 完善样式定义

8. **MenuBar 事件传递错误**
   - **问题**: MenuBar 发射整个菜单对象，但 Home.vue 期望接收菜单 ID
   - **影响**: 菜单切换功能失效
   - **修复**: 修改为发射 m.id 而不是整个对象

### ✨ 新增功能 (New Features)

1. **JWT 认证中间件**
   - 创建 middleware/auth.js
   - 保护所有管理类接口 (POST, PUT, DELETE)
   - 支持 Bearer Token 认证
   - 提供清晰的错误信息（未提供令牌、令牌过期、令牌无效）

2. **输入验证**
   - 登录/注册: 验证用户名和密码格式
     - 用户名: 3-50 个字符
     - 密码: 至少 6 个字符
   - 菜单: 验证名称不为空
   - 卡片: 验证标题和链接不为空
   - 用户密码修改: 验证密码长度

3. **错误处理**
   - 添加全局错误处理中间件
   - 添加 404 处理
   - 统一错误响应格式
   - 改进错误日志输出

4. **数据库自动初始化**
   - 应用启动时自动创建数据库表
   - 自动创建默认管理员账户
   - 检测并修复损坏的数据库文件
   - 支持环境变量配置管理员账号

5. **生产环境支持**
   - 添加静态文件服务（生产模式）
   - Docker 多阶段构建
   - 健康检查配置
   - 环境变量支持

### 📝 文档更新 (Documentation)

1. **开发文档**
   - 创建 README.dev.md
   - 详细的 API 接口文档
   - 项目结构说明
   - 常见问题解答
   - 开发规范

2. **变更日志**
   - 创建 CHANGELOG.md
   - 记录所有重要变更

### 🔒 安全改进 (Security)

1. **认证保护**
   - 所有管理接口需要 JWT 认证
   - 密码使用 bcrypt 哈希存储
   - JWT Token 7天有效期

2. **输入验证**
   - 防止空值和格式错误
   - SQL 注入防护（使用参数化查询）
   - XSS 防护（输入验证）

3. **.gitignore 保护**
   - 排除 .env 文件
   - 排除 node_modules
   - 排除日志文件

### 🎨 样式改进 (Styling)

1. **全局样式**
   - 创建统一的全局样式
   - 改进按钮、输入框样式
   - 响应式设计支持

2. **组件样式**
   - 完善 MenuBar 样式
   - 改进 CardGrid 布局
   - 添加 hover 效果

### 🏗️ 架构改进 (Architecture)

1. **中间件分离**
   - 创建独立的 middleware/ 目录
   - 认证逻辑模块化

2. **数据库管理**
   - 数据库初始化逻辑分离
   - Schema 文件独立管理
   - 支持数据库版本迁移（基础）

3. **错误处理**
   - 集中式错误处理
   - 统一响应格式
   - 改进日志记录

### ⚙️ 配置改进 (Configuration)

1. **环境变量支持**
   - PORT: 服务端口
   - JWT_SECRET: JWT 密钥
   - DB_PATH: 数据库路径
   - ADMIN_USERNAME: 管理员用户名
   - ADMIN_PASSWORD: 管理员密码
   - NODE_ENV: 运行环境

### 🧪 测试 (Testing)

- ✅ 后端启动测试通过
- ✅ 数据库初始化测试通过
- ✅ 登录接口测试通过
- ✅ 认证中间件测试通过
- ✅ API 接口测试通过

### 📦 依赖更新 (Dependencies)

#### 后端
- express: ^4.18.2
- cors: ^2.8.5
- body-parser: ^1.20.2
- sqlite3: ^5.1.6
- bcryptjs: ^2.4.3
- jsonwebtoken: ^9.0.2
- multer: ^1.4.5-lts.1

#### 前端
- vue: ^3.5.0
- vue-router: ^4.4.5
- axios: ^1.7.2
- vite: ^5.3.3
- @vitejs/plugin-vue: ^5.0.5

---

## 验收标准完成情况

- ✅ 复现步骤执行时不再出现错误
- ✅ 相关接口返回 2xx 且数据正确
- ✅ 后端日志无未捕获异常
- ✅ 前端控制台无报错
- ✅ 关键路径可正常使用：
  - ✅ 菜单加载
  - ✅ 卡片列表
  - ✅ 登录鉴权
  - ✅ API 认证保护
- ✅ 构建通过
- ✅ 所有关键功能测试通过

## 后续优化建议

1. **测试覆盖**
   - 添加单元测试
   - 添加集成测试
   - 添加 E2E 测试

2. **功能完善**
   - 实现完整的菜单管理页面
   - 添加文件上传功能
   - 添加数据导入导出

3. **性能优化**
   - 添加缓存机制
   - 优化数据库查询
   - 添加分页功能

4. **安全加固**
   - 添加请求限流
   - 添加 CSRF 保护
   - 完善日志审计

5. **用户体验**
   - 添加加载状态
   - 改进错误提示
   - 添加操作确认对话框
